language: cpp
compiler: gcc

# Linux build
sudo: required
dist: trusty

# OS X build
matrix:
  include:
    - os: osx

# Codecov token
env:
  global:
    - CODECOV_TOKEN=068ef4e2-5006-4f45-9545-fbf4e22ad085

# Qt packages for Linux
addons:
  apt:
    sources:
      - sourceline: 'ppa:ubuntu-sdk-team/ppa'
    packages:
      - qt5-qmake
      - qtbase5-dev
      - qtdeclarative5-dev
      - qtscript5-dev
      - qtmultimedia5-dev
      - libpulse-dev
      - qt5-default
      - qttools5-dev-tools
      - sshpass

# Qt packages for OS X
install:
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
      brew update &&
      brew install qt5 &&
      QT_PATH=$(find /usr/local/Cellar/qt5/* -maxdepth 0 -type d | head -1)
      PATH=$QT_PATH/bin:$PATH &&
      export PATH
    ; fi

# Start X before running tests on Linux
before_script:
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
      export DISPLAY=:99.0 &&
      sh -e /etc/init.d/xvfb start &&
      sleep 3
    ; fi

# Build Grabber
script:
  - qmake Grabber.pro
  - make
  - ./tests/build/release/tests

# Upload code coverage
after_success:
  - bash <(curl -s https://codecov.io/bash)
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]] && [[ "$TRAVIS_PULL_REQUEST" == "false" ]]; then
      zip -r Grabber.zip release &&
      OUTPUT_FILE="~/Grabber.$TRAVIS_BRANCH.$TRAVIS_TAG.zip"
      sshpass -p "$SSH_PASS" scp -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no Grabber.zip $SSH_USER@$SSH_HOST:$OUTPUT_FILE
    ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]] && [[ "$TRAVIS_PULL_REQUEST" == "false" ]]; then
      zip -r Grabber.app.zip release/Grabber.app &&
      OUTPUT_FILE="~/Grabber.$TRAVIS_BRANCH.$TRAVIS_TAG.app.zip"
      sshpass -p "$SSH_PASS" scp -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no Grabber.app.zip $SSH_USER@$SSH_HOST:$OUTPUT_FILE
    ; fi
